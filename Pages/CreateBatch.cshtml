@page
@model CreateBatchModel
@{
    ViewData["Title"] = "Create Batch";
}

<style>
    :root {
        --primary-color: #0d6efd;
        --success-color: #198754;
        --card-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        --transition-speed: 0.2s;
    }

    body {
        background: #f8f9fa;
        min-height: 100vh;
    }

    .page-header {
        background: #0d6efd;
        color: white;
        padding: 1.5rem 2rem;
        border-radius: 8px;
        box-shadow: var(--card-shadow);
        margin-bottom: 2rem;
    }

    .header-icon {
        width: 45px;
        height: 45px;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .page-title {
        font-size: 1.75rem;
        font-weight: 600;
        margin: 0;
    }

    .page-subtitle {
        font-size: 0.95rem;
        opacity: 0.95;
        margin: 0.25rem 0 0 0;
    }

    .modern-card {
        background: white;
        border-radius: 8px;
        box-shadow: var(--card-shadow);
        padding: 1.5rem;
        margin-bottom: 2rem;
        border: 1px solid #dee2e6;
    }

    .table-card {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: var(--card-shadow);
        border: 1px solid #dee2e6;
    }

    .table-card-header {
        background: #0d6efd;
        color: white;
        padding: 1rem 1.5rem;
        font-weight: 600;
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .table-responsive {
        overflow-x: auto;
    }

    .modern-table {
        width: 100%;
        margin: 0;
        border-collapse: separate;
        border-spacing: 0;
    }

    .modern-table thead th {
        background: #f8f9fa;
        font-weight: 600;
        padding: 0.5rem 0.25rem;
        text-align: center;
        border-bottom: 2px solid #dee2e6;
        position: sticky;
        top: 0;
        z-index: 10;
        font-size: 0.85rem;
    }

    .modern-table tbody tr {
        transition: background-color var(--transition-speed);
    }

    .modern-table tbody tr:hover {
        background: #f8f9fa;
    }

    .modern-table tbody td {
        padding: 0.5rem 0.25rem;
        text-align: center;
        border-top: 1px solid #dee2e6;
        vertical-align: middle;
        font-size: 0.85rem;
    }

    .action-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .btn-modern {
        padding: 0.75rem 2rem;
        border-radius: 6px;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: all var(--transition-speed);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1rem;
    }

    .btn-create {
        background: #198754;
        color: white;
    }

    .btn-create:hover {
        background: #157347;
    }

    .btn-cancel {
        background: #6c757d;
        color: white;
    }

    .btn-cancel:hover {
        background: #5c636a;
    }

    .alert-modern {
        padding: 1rem 1.5rem;
        border-radius: 6px;
        border: 1px solid;
        margin-bottom: 2rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        box-shadow: var(--card-shadow);
    }

    .alert-warning-modern {
        background: #fff3cd;
        border-color: #ffecb5;
        color: #664d03;
    }

    .alert-icon {
        width: 24px;
        height: 24px;
        flex-shrink: 0;
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
        background: #6c757d;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #495057;
    }

    /* Select dropdown styling */
    .form-select {
        padding: 0.375rem 0.5rem;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.85rem;
        min-width: 120px;
        max-width: 140px;
        background-color: white;
        cursor: pointer;
    }

    .form-select:disabled {
        background-color: #e9ecef;
        cursor: not-allowed;
    }

    .form-select:focus {
        border-color: #0d6efd;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }

    /* Wide container for better table display */
    .container-wide {
        max-width: 95%;
        margin: 0 auto;
        padding: 0 15px;
    }

    /* Recipe cards styling */
    .recipe-cards-container {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    .recipe-step-section {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .recipe-step-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #0d6efd;
        padding: 0.5rem 0;
        border-bottom: 2px solid #0d6efd;
        margin-bottom: 0.5rem;
    }

    .recipe-card {
        background: white;
        border-radius: 8px;
        box-shadow: var(--card-shadow);
        border: 1px solid #dee2e6;
        overflow: hidden;
    }

    .recipe-card-header {
        background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
        color: white;
        padding: 0.75rem 1rem;
        font-weight: 600;
        font-size: 0.95rem;
    }

    .recipe-card-body {
        padding: 1rem;
    }

    .recipe-info-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #e9ecef;
    }

    .recipe-info-row:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }

    .recipe-info-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .recipe-info-label {
        font-size: 0.75rem;
        color: #6c757d;
        font-weight: 600;
    }

    .recipe-info-value {
        font-size: 0.85rem;
        color: #212529;
        font-weight: 500;
    }

    .recipe-pos-row {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 0.5rem;
    }

    .recipe-pos-item {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        text-align: center;
    }
</style>

<div class="container-wide mt-4">
    <!-- Header -->
    <div class="page-header">
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                <div class="header-icon me-3">
                    <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7" rx="1"/>
                        <rect x="14" y="3" width="7" height="7" rx="1"/>
                        <rect x="14" y="14" width="7" height="7" rx="1"/>
                        <rect x="3" y="14" width="7" height="7" rx="1"/>
                    </svg>
                </div>
                <div>
                    <h1 class="page-title">Create Batch</h1>
                    <p class="page-subtitle">バッチ作成</p>
                </div>
            </div>
        </div>
    </div>

    @if (Model.CarrierSteps.Any())
    {
        <form method="post">
            <input type="hidden" name="Carriers" value="@Model.Carriers" />

            @* Hidden fields for carrier data *@
            @foreach (var (carrierStep, index) in Model.CarrierSteps.Select((cs, i) => (cs, i)))
            {
                <input type="hidden" name="CarrierData[@index].Carrier" value="@carrierStep.Carrier" />
                <input type="hidden" name="CarrierData[@index].LotId" value="@carrierStep.LotId" />
                <input type="hidden" name="CarrierData[@index].Technology" value="@carrierStep.Technology" />
                <input type="hidden" name="CarrierData[@index].Qty" value="@carrierStep.Qty" />
            }

            <!-- Table Card -->
            <div class="table-card">
                <div class="table-card-header">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 11l3 3L22 4"/>
                        <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
                    </svg>
                    キャリアステップ情報
                </div>
                <div class="table-responsive">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th rowspan="2">Carrier</th>
                                <th rowspan="2">LotId</th>
                                <th colspan="2">Step 1</th>
                                <th colspan="2">Step 2</th>
                                <th colspan="2">Step 3</th>
                                <th colspan="2">Step 4</th>
                            </tr>
                            <tr>
                                <th>PPID</th>
                                <th>EqpId</th>
                                <th>PPID</th>
                                <th>EqpId</th>
                                <th>PPID</th>
                                <th>EqpId</th>
                                <th>PPID</th>
                                <th>EqpId</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var (carrierStep, index) in Model.CarrierSteps.Select((cs, i) => (cs, i)))
                            {
                                <tr>
                                    <td id="carrier-@index"><strong>@carrierStep.Carrier</strong></td>
                                    <td id="lotid-@index">@carrierStep.LotId</td>
                                    @for (int step = 1; step <= 4; step++)
                                    {
                                        <td id="step@(step)-ppid-@index">
                                            <select name="ppid_@(carrierStep.Carrier)_@(step)"
                                                    id="ppid_@(carrierStep.Carrier)_@(step)"
                                                    class="form-select ppid-select"
                                                    data-carrier="@carrierStep.Carrier"
                                                    data-step="@step"
                                                    onchange="updateEqpIdOptions(this)">
                                                <option value="">選択してください</option>
                                            </select>
                                        </td>
                                        <td id="step@(step)-eqp-@index">
                                            <select name="eqpid_@(carrierStep.Carrier)_@(step)"
                                                    id="eqpid_@(carrierStep.Carrier)_@(step)"
                                                    class="form-select eqpid-select"
                                                    data-carrier="@carrierStep.Carrier"
                                                    data-step="@step">
                                                <option value="">選択してください</option>
                                            </select>
                                        </td>
                                    }
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Equipment Recipe Information -->
            <div id="recipeInfoContainer" style="margin-top: 2rem;">
                <h5 style="margin-bottom: 1rem; color: #0d6efd; font-weight: 600;">装置レシピ情報</h5>
                <div id="recipeCardsContainer" class="recipe-cards-container">
                    <!-- Recipe cards will be dynamically inserted here -->
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button type="submit" class="btn-modern btn-create">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 11l3 3L22 4"/>
                        <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
                    </svg>
                    <span>作成</span>
                </button>
                <a href="/WipLotList?EqpName=@Uri.EscapeDataString(Model.EqpName ?? "")" class="btn-modern btn-cancel">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                    <span>キャンセル</span>
                </a>
            </div>
        </form>
    }
    else
    {
        <div class="alert-modern alert-warning-modern">
            <svg class="alert-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <div>
                <strong>キャリア情報が見つかりません。</strong>
                <div style="font-size: 0.9rem; margin-top: 0.25rem;">
                    WIP Lot Listから適切なキャリアを選択してください。
                </div>
            </div>
        </div>
        <a href="/" class="btn-modern btn-cancel">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                <polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
            <span>Dashboardに戻る</span>
        </a>
    }
</div>

<script>
    // Parse step options from server
    const stepOptions = @Html.Raw(Model.StepOptionsJson);

    // Initialize dropdowns on page load
    document.addEventListener('DOMContentLoaded', function() {
        initializeDropdowns();
    });

    function initializeDropdowns() {
        // For each carrier
        Object.keys(stepOptions).forEach(carrier => {
            const carrierData = stepOptions[carrier];

            // For each step (1-4)
            for (let step = 1; step <= 4; step++) {
                const ppidSelect = document.getElementById(`ppid_${carrier}_${step}`);
                const eqpIdSelect = document.getElementById(`eqpid_${carrier}_${step}`);

                if (!ppidSelect || !eqpIdSelect) continue;

                const stepData = carrierData[step] || [];

                if (stepData.length === 0) {
                    // No data for this step, disable both dropdowns
                    ppidSelect.disabled = true;
                    eqpIdSelect.disabled = true;
                    continue;
                }

                // Get unique PPIDs for this step
                const uniquePPIDs = [...new Set(stepData.map(item => item.PPID))];

                // Populate PPID dropdown
                uniquePPIDs.forEach(ppid => {
                    const option = document.createElement('option');
                    option.value = ppid;
                    option.textContent = ppid;
                    ppidSelect.appendChild(option);
                });

                // Store all step data as data attribute for later use
                ppidSelect.setAttribute('data-step-options', JSON.stringify(stepData));
            }
        });
    }

    function updateEqpIdOptions(ppidSelect) {
        const carrier = ppidSelect.getAttribute('data-carrier');
        const step = ppidSelect.getAttribute('data-step');
        const selectedPPID = ppidSelect.value;

        const eqpIdSelect = document.getElementById(`eqpid_${carrier}_${step}`);

        if (!eqpIdSelect) return;

        // Clear existing options
        eqpIdSelect.innerHTML = '<option value="">選択してください</option>';

        if (!selectedPPID) {
            eqpIdSelect.disabled = true;
            // Clear recipe info for this step
            removeRecipeCard(carrier, step);
            return;
        }

        // Get step data
        const stepDataStr = ppidSelect.getAttribute('data-step-options');
        if (!stepDataStr) return;

        const stepData = JSON.parse(stepDataStr);

        // Filter EqpIds that match the selected PPID
        const matchingEqpIds = stepData
            .filter(item => item.PPID === selectedPPID)
            .map(item => item.EqpId);

        // Get unique EqpIds
        const uniqueEqpIds = [...new Set(matchingEqpIds)];

        // Populate EqpId dropdown
        uniqueEqpIds.forEach(eqpId => {
            const option = document.createElement('option');
            option.value = eqpId;
            option.textContent = eqpId;
            eqpIdSelect.appendChild(option);
        });

        eqpIdSelect.disabled = false;

        // Auto-select if only one option
        if (uniqueEqpIds.length === 1) {
            eqpIdSelect.value = uniqueEqpIds[0];
            // Fetch recipe info for auto-selected EqpId
            fetchAndDisplayRecipeInfo(carrier, step, selectedPPID, uniqueEqpIds[0]);
        }

        // Add event listener to EqpId select
        eqpIdSelect.onchange = function() {
            const selectedEqpId = this.value;
            if (selectedEqpId && selectedEqpId !== '選択してください') {
                fetchAndDisplayRecipeInfo(carrier, step, selectedPPID, selectedEqpId);
            } else {
                removeRecipeCard(carrier, step);
            }
        };
    }

    // Fetch and display recipe information
    async function fetchAndDisplayRecipeInfo(carrier, step, ppid, eqpId) {
        try {
            const response = await fetch(`/CreateBatch?handler=RecipeInfo&eqpId=${encodeURIComponent(eqpId)}&ppid=${encodeURIComponent(ppid)}`);
            const data = await response.json();

            displayRecipeCard(carrier, step, data);
        } catch (error) {
            console.error('Error fetching recipe info:', error);
        }
    }

    // Display recipe card
    function displayRecipeCard(carrier, step, recipeData) {
        const container = document.getElementById('recipeCardsContainer');
        const stepSectionId = `recipe-step-section-${step}`;
        const cardId = `recipe-card-${carrier}-${step}`;

        // Remove existing card if present
        const existingCard = document.getElementById(cardId);
        if (existingCard) {
            existingCard.remove();
        }

        // Get or create step section
        let stepSection = document.getElementById(stepSectionId);
        if (!stepSection) {
            stepSection = document.createElement('div');
            stepSection.id = stepSectionId;
            stepSection.className = 'recipe-step-section';
            stepSection.setAttribute('data-step', step);

            // Create step title
            const stepTitle = document.createElement('div');
            stepTitle.className = 'recipe-step-title';
            stepTitle.textContent = `Step ${step}`;
            stepSection.appendChild(stepTitle);

            // Insert section in the correct order
            insertStepSectionInOrder(container, stepSection, step);
        }

        // Create new card
        const card = document.createElement('div');
        card.id = cardId;
        card.className = 'recipe-card';
        card.innerHTML = `
            <div class="recipe-card-header">
                ${carrier}
            </div>
            <div class="recipe-card-body">
                <div class="recipe-info-row">
                    <div class="recipe-info-item">
                        <div class="recipe-info-label">EqpId</div>
                        <div class="recipe-info-value">${recipeData.eqpId}</div>
                    </div>
                    <div class="recipe-info-item">
                        <div class="recipe-info-label">PPID</div>
                        <div class="recipe-info-value">${recipeData.ppid}</div>
                    </div>
                    <div class="recipe-info-item">
                        <div class="recipe-info-label">OK/NG</div>
                        <div class="recipe-info-value">${recipeData.okNg}</div>
                    </div>
                    <div class="recipe-info-item">
                        <div class="recipe-info-label">特記事項</div>
                        <div class="recipe-info-value">${recipeData.specialNotes}</div>
                    </div>
                </div>
                <div class="recipe-info-row">
                    <div class="recipe-info-item">
                        <div class="recipe-info-label">Trench Dummy</div>
                        <div class="recipe-info-value">${recipeData.trenchDummy}</div>
                    </div>
                    <div class="recipe-info-item">
                        <div class="recipe-info-label">DM種別</div>
                        <div class="recipe-info-value">${recipeData.dmType}</div>
                    </div>
                    <div class="recipe-info-item">
                        <div class="recipe-info-label">TW種別</div>
                        <div class="recipe-info-value">${recipeData.twType}</div>
                    </div>
                </div>
                <div class="recipe-pos-row">
                    <div class="recipe-pos-item">
                        <div class="recipe-info-label">POS-A</div>
                        <div class="recipe-info-value">${recipeData.posA}</div>
                    </div>
                    <div class="recipe-pos-item">
                        <div class="recipe-info-label">POS-B</div>
                        <div class="recipe-info-value">${recipeData.posB}</div>
                    </div>
                    <div class="recipe-pos-item">
                        <div class="recipe-info-label">POS-C</div>
                        <div class="recipe-info-value">${recipeData.posC}</div>
                    </div>
                    <div class="recipe-pos-item">
                        <div class="recipe-info-label">POS-D</div>
                        <div class="recipe-info-value">${recipeData.posD}</div>
                    </div>
                    <div class="recipe-pos-item">
                        <div class="recipe-info-label">POS-E</div>
                        <div class="recipe-info-value">${recipeData.posE}</div>
                    </div>
                    <div class="recipe-pos-item">
                        <div class="recipe-info-label">POS-F</div>
                        <div class="recipe-info-value">${recipeData.posF}</div>
                    </div>
                </div>
            </div>
        `;

        stepSection.appendChild(card);
    }

    // Insert step section in the correct order (Step 1, 2, 3, 4)
    function insertStepSectionInOrder(container, newSection, newStep) {
        const existingSections = Array.from(container.querySelectorAll('.recipe-step-section'));

        if (existingSections.length === 0) {
            container.appendChild(newSection);
            return;
        }

        // Find the correct position to insert
        let inserted = false;
        for (const section of existingSections) {
            const sectionStep = parseInt(section.getAttribute('data-step'));
            if (newStep < sectionStep) {
                container.insertBefore(newSection, section);
                inserted = true;
                break;
            }
        }

        // If not inserted, append at the end
        if (!inserted) {
            container.appendChild(newSection);
        }
    }

    // Remove recipe card
    function removeRecipeCard(carrier, step) {
        const cardId = `recipe-card-${carrier}-${step}`;
        const card = document.getElementById(cardId);
        if (card) {
            card.remove();

            // Check if step section is now empty (only has title)
            const stepSectionId = `recipe-step-section-${step}`;
            const stepSection = document.getElementById(stepSectionId);
            if (stepSection) {
                const cards = stepSection.querySelectorAll('.recipe-card');
                if (cards.length === 0) {
                    stepSection.remove();
                }
            }
        }
    }
</script>
